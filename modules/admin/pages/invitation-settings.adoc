= Настройка функций обмена приглашениями ЭДО

// tag::work-with[]
WARNING: Работа с приглашениями по умолчанию производится только из {wc}а. Для работы с приглашениями через {wincl} администратор должен самостоятельно настроить разметки.
// end::work-with[]

Для работы с приглашениями к обмену предназначены карточки:

* Исходящее приглашение ЭДО.
* Входящее приглашение ЭДО.

Указанные виды карточек предоставляются с настроенными разметками, автоматом состояний и ролевой моделью.

[#folders]
== Настройка папок для приглашений ЭДО

// Для удобства работы с приглашениями ЭДО администратор может самостоятельно добавить пользователям модуля виртуальные папки со следующими поисковыми запросами:
//
// * _Журнал Все приглашения_ -- возвращает все виды приглашений во всех статусах.
// * _Журнал Исходящие приглашения_ -- возвращает только исходящие приглашения во всех статусах.
// * _Журнал Входящие приглашения_ -- возвращает только входящие приглашения во всех статусах.
// * _Поиск Приглашений_ -- выполняет поиск приглашений по различным полям.
//
// В настройках данных папок рекомендуется установить представление по умолчанию -- _Приглашения ЭДО_.
//
Поисковые запросы и представления для папок входящих приглашений ЭДО, если требуется, могут быть разработаны самостоятельно.

[#layout]
== Настройка разметки вида "Входящее приглашение ЭДО"

Карточка входящего приглашения запрещена для создания пользователем.

. В справочнике Операторов ЮЗДО на вкладке _Компоненты_ в поле _Отправка_ добавьте виды _Входящее приглашение ЭДО_ и _Исходящее приглашение ЭДО_.
. Укажите компонент чтения `InvitationDataReader`, компонент обновления `DocumentUpdater`.
+
.Виды "Входящее приглашение ЭДО" и "Исходящее приглашение ЭДО"
image::new-kinds.png[Виды "Входящее приглашение ЭДО" и "Исходящее приглашение ЭДО"]
+
. В разметку _Исходящего приглашения ЭДО_ добавьте элемент управления _Подразделение Контрагента_.
. В поле _Источник данных_ укажите *_Договор_*, поле данных -- *_Организация контрагента_*.
+
.Указание источника данных
image::data-source.png[Указание источника данных]
+
. Откройте в _Конструкторе разметок_ настройки вида _Входящее приглашение ЭДО_, _Исходящее приглашение ЭДО_.
. Добавьте на ленту карточки новую группу с названием _Электронный обмен_.
. Добавьте в группу _Электронный обмен_ команды:
+
* Для разметки _Исходящего приглашения_:
** *Отправить* приглашение.
** *Отозвать* приглашение.
* Для разметки _Входящего приглашения_:
** *Принять* приглашение.
** *Отказать* в принятии приглашения.
+
. Укажите операции доступа для добавленных команд.
. Добавьте в скрипт родительского вида, _Обмен приглашениями_, ссылку на дополнительную сборку `DocsVision.Edi.DocumentScript.dll`.
. В скрипты _Исходящего_ и _Входящего_ приглашений добавьте пространство:
+
[source,csharp]
----
using DocsVision.Edi.DocumentScript;
----
+
// . В скрипты _Исходящего_ и _Входящего_ приглашений добавьте следующий обработчик событий:
// +
// [source,javascript]
// ----
// private EdiScriptHelper ediScriptHelper;
// public EdiScriptHelper EdiScriptHelper
// {
//   get
//     {
//       if (ediScriptHelper == null)
//       ediScriptHelper = new EdiScriptHelper(CardControl);
//       return ediScriptHelper;
//     }
//   }
// ----
// +
. В раздел подключаемых пространств имен добавьте:
+
[source,csharp]
----
using DocsVision.Edi.EdiScriptHelpers;
----
+
. Добавьте обработчики для новых команд:
+
.Для команды _Отправить_ приглашение:
[source,csharp]
----
EdiScriptHelper.SendInvitation();
----
+
.Для команды _Отозвать_ приглашение:
[source,csharp]
----
EdiScriptHelper.CancelInvitation();
----
+
.Для команды _Принять_ приглашение:
[source,csharp]
----
EdiScriptHelper.AcceptInvitation();
----
+
.Для команды _Отказать_ в принятии приглашения:
[source,csharp]
----
EdiScriptHelper.RejectInvitation();
----
+
. Добавьте в разметку карточки элемент управления _Журнал работы с приглашениями_. Рекомендуется размещать элемент управления на новой вкладке (например, _Журнал работы с приглашениями ЮЗДО_). Настраивать элемент управления не требуется.
. Загрузите БП для обмена приглашениями:
+
* `CardPackage\ReceiveEdiInvitations.xml` -- для получения входящих приглашений к обмену.
* `CardPackage\SendEdiInvitations.xml` -- для отправки исходящих приглашений к обмену.

[#layouts]
== Настройки web-разметок

Для работы с приглашениями ЭДО в {wc}е можно самостоятельно настроить web-разметки.

.События и обработчики событий исходящих приглашений:
* Для кнопки *Отправить* необходимо назначить имя `ediSignAndSendButton`
* Для кнопки *Отозвать* необходимо назначить имя `ediRecallButton`
* `edi_OutgoingInvitation_cancelClick` -- событие нажатия на кнопку *Отозвать*.
* `edi_OutgoingInvitation_signAndSendClick` -- событие нажатия на кнопку -- *Подписать и отправить*.
** Событие требует заполнения поля `Contract.PartnerCompany` -- организация контрагента, получатель приглашения.
* `edi_OutgoingInvitation_cardOpening` -- перед открытием карточки.
* `edi_OutgoingInvitation_cardOpened` -- после открытия карточки.

Кнопка *Отправить* доступна только если ещё приглашение не было отправлено ранее. Для повторной отправки потребуется создать новую карточку.
Кнопка *Отозвать* доступна в отправленном приглашении, пока приглашение не принято или не отправлен отказ.

.События и обработчики событий входящих приглашений:
* `edi_IncomingInvitation_cardOpening` -- событие перед открытием карточки.
* `edi_IncomingInvitation_cardOpened` -- событие после открытия карточки.
* *edi_IncomingInvitation_acceptInvitationClick* -- событие нажатия на кнопку -- *Принять*.
* *edi_IncomingInvitation_declineInvitationClick* -- событие нажатия на кнопку -- *Отклонить*.
* Кнопка *Принять* приглашение должна иметь имя `ediAcceptInvitationButton`.
* Кнопка *Отклонить* приглашение должна иметь имя `ediDeclineInvitationButton`.

