= Настройка работы с МЧД

В данном разделе описаны необходимые настройки для работы с МЧД и отправки доверенности в распределённый реестр. Инструкция подходит как для {wincl}а, так и для {wc}а. Расширение позволяет использовать МЧД в диалогах подписания ЮЗДО.

[#prerequisites]
== Требования для работы с МЧД

// .МЧД с СКД:
* Модуль _{bo}_ с поддержкой МЧД версии {bo-req-m4d} и выше.footnote:[Если использовать МЧД не планируется, требования можно снизить до _{bo}_ версии {bo-req}. Большинство функций, описанных в xref:m4d@webclient:programmer:other/powers-of-attorney.adoc[примере решения МЧД для {wc}а] окажутся недоступны.]
* Модуль _{em}_ версии {edi-req-m4d} и выше.
* *Для работы через интерфейс {wc}а.* Модуль _{wc}_ {wc-req-m4d} и выше с установленными _Компонентами модуля интеграции с операторами ЭДО_.footnote:[Для работы без МЧД потребуется модуль _{wc}_ {wc-req} и выше с установленными _Компонентами модуля интеграции с операторами ЭДО_. Большинство функций, описанных в xref:m4d@webclient:programmer:other/powers-of-attorney.adoc[примере решения МЧД для {wc}а] окажутся недоступны.]
** Пример решения МЧД для {wc}а: "xref:m4d@webclient:programmer:other/powers-of-attorney.adoc[]".

[#config]
== Необходимые настройки

include::ROOT:partial$excerpts.adoc[tags=connector]
. Убедитесь в присутствии необходимых опций лицензии {dv}. См. раздел xref:ROOT:requirements.adoc#license[Требования].
. Выполните необходимые настройки подписания, см. подробнее в документации xref:6.1@backoffice:admin:system-settings.adoc#signature-cypher[модуля {bo}] и xref:6.1@webclient::requirements-signature.adoc[{wc}].
. Убедитесь, что в справочнике сотрудников указан руководитель организации, который должен будет подписать МЧД.
+
.В карточке руководителя организации обязательно должны быть заполнены следующие поля:
* Фамилия.
* Имя.
* Отчество.
* Дата рождения.
* Должность.
* Рабочий телефон.
* Домашний телефон.
* Мобильный телефон.
* Номер паспорта.
+
. Убедитесь, что в справочнике сотрудников корректно указан сотрудник, для которого выдаётся МЧД. +
В карточке сотрудника обязательно должны быть заполнены те же поля, что и для руководителя организации. Указывать номер паспорта необязательно.
+
. Убедитесь, что в справочнике сотрудников создана организация со следующими обязательными полями:
+
* Название.
* Полное название.
* Руководитель -- руководитель организации, созданный ранее.
* Адрес.
* Телефон.
* ОКПО.
* ОГРН.
* КПП.
* ИНН.
+
. Убедитесь, что в справочнике контрагентов указана организация контрагента со следующими обязательно заполненными полями:
+
* Название.
* КПП.
* ИНН.
+
. Выполните загрузку контрагентов в xref:operators-directory.adoc[Справочнике настроек операторов ЮЗДО].
. В _Справочнике настроек операторов ЮЗДО_ на вкладке _Сервисы_ выберите `DocsVision.Edi.Runtime.Diadoc` в качестве сервиса для работы с МЧД.
+
.Сервис для работы с МЧД
image::attorney-service.png[Сервис для работы с МЧД]
+
. Создайте вид карточки для работы с МЧД. Для {wc}а можно воспользоваться готовым примером. Для этого нужно импортировать вид карточки документа ПКД menu:PowersOfAttorney[Data > SolutionOfPOA.sol] из примера "xref:m4d@webclient:programmer:other/powers-of-attorney.adoc[]".
. В _Справочнике настроек операторов ЮЗДО_ на вкладке _Компоненты_ для выбранного вида карточек укажите:
+
* Имя класса компонента чтения: `DocsVision.Edi.Runtime.BackOffice.PowerOfAttorneyDataReader`.
* Имя класса компонента изменения: `DocsVision.Edi.Runtime.BackOffice.PowerOfAttorneyUpdater`.
+
. В карточку доверенности в соответствующем модуле системы добавьте две кнопки:
+
* Отправить МЧД со скриптом `EdiScriptHelper.SendPowerOfAttorney(Guid)` -- подписывает и отправляет файл МЧД.
+
** Если МЧД отправляется как файл, необходимо прикрепить файл и подпись.
** Если МЧД отправляется по номеру, необходимо, чтобы в доверенности были указаны номер и ИНН доверителя.
+
****
При наличии xref:ROOT:requirements.adoc#license[опции лицензии] {dv} _Модуль интеграции с реестром МЧД_ после подписания возможно отправлять доверенность на регистрацию в распределённый реестр ФНС.
****
+
* Отозвать МЧД со скриптом `EdiScriptHelper.RevokePowerOfAttorney(Guid)` -- отвязывает МЧД от сотрудника в Диадок.
+
. В карточку доверенности добавьте ЭУ `_Журнал МЧД_`
+
.Для работы с МЧД предназначены два метода:
* Метод `public bool SendPowerOfAttorney(Guid powerOfAttorneyCardId)` передает в Диадок для регистрации номер МЧД (в СКД в секции `MainInfo` поле `PowerOfAttorneyNumber`) и ИНН доверителя (в СКД в секции `MainInfo` поле `PrincipalINN`).
** При этом сценарии МЧД должна быть предварительно зарегистрирована в реестре ФНС и после передачи из ДВ в Диадок регистрационного номера МЧД и ИНН доверителя МЧД в Диадок привязывается к пользователю.
* Метод `public bool SendPowerOfAttorney(Guid powerOfAttorneyCardId, bool sendAsFile)` передает в Диадок для регистрации файл МЧД (в СКД в секции `MainInfo` поле `MachineReadablePowerOfAttorney`) и файл подписи (в СКД в секции `MainInfo` поле `Signature`) и регистрирует.
** При этом сценарии МЧД в Диадок привязывается к пользователю и проходит регистрацию в реестре ФНС.
+
. Убедитесь, что в карточке сотрудника, который будет подписывать документы с МЧД, установлен флаг `*Требуется доверенность при подписании документов*`.
+
* Для {wc}а см. раздел "xref:6.1@webclient:user:directories/staff/employee-fields.adoc#attorney[Поля вкладки "Основная" в карточке сотрудника]".
* Для {wincl}а см. раздел "xref:6.1@backoffice:desdirs:staff/employees/main-tab.adoc#attorney[Основная информация о сотруднике]".
+
. Убедитесь, что в настройках типа документа, который будет отправляться в Диадок, в справочнике видов карточек на вкладке _Подпись_ настройка _Использовать машиночитаемую доверенность при подписании документов_ установлена в значении *_Обязательно_*. Подробнее см. раздел "xref:6.1@backoffice:desdirs:card-kinds/document/sign-card.adoc#attorney[Использовать МЧД при подписании]".
. Заполните корректными данными поля в карточке ПКД по аналогии с сертификатом подписи.

// [#no-skd]
// == Настройка работы с МЧД без СКД
//
// ****
// Если планируется использовать МЧД в модуле {em} без СКД, с ограниченным набором сценариев: доступно только подписание, но не отправка в распределённый реестр, требования к модулю {bo} могут быть снижены:
//
// * Серверная и клиентская части модуля _{bo}_ версии {bo-req}.
//
// В версиях модуля _{bo}_ с поддержкой СКД ({bo-req-m4d}) работа без СКД не поддерживается. После обновления модуля _{bo}_ до версии {bo-req-m4d} необходимо загрузить имеющиеся МЧД с помощью метода `ImportPowerOfAttorney`, входящего в интерфейс "xref:programmer:BackOffice-ObjectModel-Services-IPartnersService:IPowerOfAttorneyService_IN.adoc[IPowerOfAttorneyService]".
// ****
//
// .Чтобы использовать МЧД без СКД необходимо:
// . Выполнить пункты 1-10 из <<config,инструкции>> выше.
// . Используя программу DVExplorer из комплекта утилит {rk}, импортируйте файл `CardDocument_PowerOfAttorney.xml`. Файл хранится в каталоге `C:\Program Files (x86)\Docsvision\Edi\CardPackage`.
// . С помощью программы {kvr} добавьте два xref:6.1@webclient:layouts:ctrl/standard/textBox.adoc[ЭУ "Строка"] в разметки формализованных и неформализованных исходящих документов со следующими источниками данных:
// +
// .ЭУ "Строка" в разметках исходящих документов
// image::text-box.png[ЭУ "Строка" в разметках исходящих документов]
// +
// --
// * Строка 1:
// ** `*Источник данных*`: Данные МЧД (Power of attorney data).
// ** `*Поле*`: ИНН доверителя (IssuerINN).
// * Строка 2:
// ** `*Источник данных*`: Данные МЧД (Power of attorney data).
// ** `*Поле*`: Регистрационный номер (Registration number).
// +
// WARNING: Поле _Регистрационный номер доверенности_ может быть добавлено только через разметки {wc}а. Поля типа `UniqueID` не поддерживаются ни одним ЭУ {wincl}а.
// --
